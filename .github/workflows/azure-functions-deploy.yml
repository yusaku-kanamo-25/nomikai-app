name: Deploy Azure Functions App

on:
  push:
    branches:
      - main
    paths:
      - 'backend/FunctionbeerAPI/**'
      - '.github/workflows/azure-functions-deploy.yml'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: 'nomikai-funcapp'
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: windows-latest
    environment: production
    
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Setup DotNet ${{ env.DOTNET_VERSION }} Environment
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Build and Publish'
      shell: pwsh
      run: |
        cd backend/FunctionbeerAPI
        dotnet publish FunctionbeerAPI.csproj --configuration Release --output ./publish

    - name: 'Create deployment package'
      shell: pwsh
      run: |
        Compress-Archive -Path backend/FunctionbeerAPI/publish/* -DestinationPath deploy.zip -Force

    - name: 'Deploy using Web Deploy (MSDeploy)'
      shell: pwsh
      env:
        PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
      run: |
        # Parse publish profile for credentials
        $xml = [xml]$env:PUBLISH_PROFILE
        $profile = $xml.publishData.publishProfile | Where-Object { $_.publishMethod -eq 'MSDeploy' }
        
        if (-not $profile) {
          $profile = $xml.publishData.publishProfile | Where-Object { $_.publishMethod -eq 'ZipDeploy' }
        }
        
        $username = $profile.userName
        $password = $profile.userPWD
        $siteName = $profile.msdeploySite
        
        # Use basic auth with zip deploy API
        $base64Auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${username}:${password}"))
        
        # Try the main deployment endpoint first
        $deployUrl = "https://${{ env.AZURE_FUNCTIONAPP_NAME }}.scm.azurewebsites.net/api/zipdeploy?isAsync=false"
        
        Write-Host "Deploying to: $deployUrl"
        
        try {
          $response = Invoke-WebRequest -Uri $deployUrl `
            -Method POST `
            -Headers @{ Authorization = "Basic $base64Auth" } `
            -InFile "deploy.zip" `
            -ContentType "application/zip" `
            -TimeoutSec 600 `
            -UseBasicParsing
          
          Write-Host "Deployment successful! Status: $($response.StatusCode)"
        }
        catch {
          Write-Host "Primary endpoint failed, trying alternate..."
          
          # Try alternate SCM URL format
          $altDeployUrl = "https://nomikai-funcapp-g4hdgyachmhwfxbq.scm.japaneast-01.azurewebsites.net/api/zipdeploy?isAsync=true"
          
          $response = Invoke-WebRequest -Uri $altDeployUrl `
            -Method POST `
            -Headers @{ Authorization = "Basic $base64Auth" } `
            -InFile "deploy.zip" `
            -ContentType "application/zip" `
            -TimeoutSec 600 `
            -UseBasicParsing
          
          Write-Host "Async deployment initiated! Status: $($response.StatusCode)"
          Write-Host "Waiting for deployment to complete..."
          Start-Sleep -Seconds 30
        }

    - name: 'Deployment Summary'
      run: |
        echo "### Deployment Completed! :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Function App**: ${{ env.AZURE_FUNCTIONAPP_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
