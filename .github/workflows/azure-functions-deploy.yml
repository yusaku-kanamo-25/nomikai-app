name: Deploy Azure Functions App

on:
  push:
    branches:
      - main
    paths:
      - 'backend/FunctionbeerAPI/**'
      - '.github/workflows/azure-functions-deploy.yml'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: 'nomikai-funcapp'
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: windows-latest
    environment: production
    
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Setup DotNet ${{ env.DOTNET_VERSION }} Environment
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Build and Publish'
      shell: pwsh
      run: |
        cd backend/FunctionbeerAPI
        dotnet publish FunctionbeerAPI.csproj --configuration Release --output ./publish

    - name: 'Create ZIP package'
      shell: pwsh
      run: |
        Compress-Archive -Path backend/FunctionbeerAPI/publish/* -DestinationPath deploy.zip -Force

    - name: 'Deploy to Azure Functions via Kudu ZIP Deploy'
      shell: pwsh
      env:
        PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
      run: |
        # Parse credentials from publish profile
        $xml = [xml]$env:PUBLISH_PROFILE
        $publishUrl = $xml.publishData.publishProfile[0].publishUrl
        $userName = $xml.publishData.publishProfile[0].userName
        $userPWD = $xml.publishData.publishProfile[0].userPWD
        
        # Create auth header
        $base64Auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(("{0}:{1}" -f $userName, $userPWD)))
        
        # Deploy using Invoke-RestMethod
        $apiUrl = "https://${{ env.AZURE_FUNCTIONAPP_NAME }}.scm.azurewebsites.net/api/zipdeploy"
        
        Write-Host "Deploying to $apiUrl..."
        
        Invoke-RestMethod -Uri $apiUrl -Method Post -InFile "deploy.zip" -ContentType "application/zip" -Headers @{Authorization=("Basic {0}" -f $base64Auth)} -TimeoutSec 600
        
        Write-Host "Deployment completed successfully!"

    - name: 'Deployment Summary'
      run: |
        echo "### Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Function App**: ${{ env.AZURE_FUNCTIONAPP_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
